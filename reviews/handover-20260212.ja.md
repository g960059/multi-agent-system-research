# 引き継ぎドキュメント（2026-02-12）

## 0. 現在の方針（継続前提）
1. まずは **mailbox-first PoC** を継続する。
2. `workflow module` はまだ実装しない。
3. 先に `Control Kernel` の境界（`TaskDomain -> ProcessManager -> Ports/Adapters`）を固める。
4. 外部レビュア（codex/claude）並列実行は、PoCの自己検証として継続する。

---

## 1. 今回反映した実装（Critical対応中心）

### 1.1 ランタイム実装
1. `from` と `sender_id` の一致検証を追加。
   - `src/poc/runtime.ts:113`
2. reviewer失敗コード（auth/network/execution）の抽出と集計を追加。
   - `src/poc/runtime.ts:373`
   - `src/poc/runtime.ts:398`
3. review入力のデフォルトを軽量化（summary-only）。
   - full diff は明示フラグ `--include-full-git-diff` のときのみ。
   - `src/poc/runtime.ts:592`
4. CLIホーム切替モードを追加。
   - `isolated`（既定）/ `host`（既存ログイン利用）
   - `src/poc/runtime.ts:739`
   - `src/poc/runtime-main.ts:30`
5. ランタイム結果JSONに運用ゲート情報を追加。
   - `reviewer_failure_counts` / `operational_gate` / `dedup_policy`
   - `src/poc/runtime-main.ts:50`
   - `src/poc/runtime-main.ts:80`

### 1.2 E2Eテスト追加
1. `from/sender_id` 不一致時に隔離される異常系を追加。
   - `src/poc/e2e.ts:93`

### 1.3 CLI事前確認の改善
1. `POC_CLI_HOME_MODE`（isolated/host）対応。
2. `POC_CLI_CHECK_TIMEOUT_MS` でtimeout調整可能化。
   - `src/poc/cli-preflight.ts:60`

### 1.4 npm scripts調整
1. `poc:runtime:cli` の既定値を実運用寄りに調整。
   - timeout: 240000
   - review input: 80000 / excerpt 12000
   - `package.json`

---

## 2. 設計・契約ドキュメント反映

1. outbox relay責務の矛盾を解消（Mailbox責務から除外し Runtime Supervisorへ寄せた）。
   - `plan/00-module-boundary-and-interface-contract.ja.md:117`
   - `plan/00-module-boundary-and-interface-contract.ja.md:144`
2. envelope例の `payload.task_id` 欠落を修正。
   - `plan/00-module-boundary-and-interface-contract.ja.md:323`
3. `from == sender_id` を契約ルールとして明記。
   - `plan/00-module-boundary-and-interface-contract.ja.md:350`
4. strict v1 と N-1互換テストの整合を明文化。
   - `plan/00-module-boundary-and-interface-contract.ja.md:502`
5. runtime設定例に運用ゲート・dedup耐久境界を追加。
   - `plan/mailbox-poc-runtime.example.yaml`
6. runbookに `cli-home-mode` と運用ゲート手順を追記。
   - `plan/mailbox-poc-runbook.ja.md`
7. 後続ロードマップを新規作成。
   - `plan/mailbox-poc-roadmap-next.ja.md`

---

## 3. 実行結果（最新確認）

1. `npm run poc:e2e`
   - PASS: happy path duplicate no-op+ack
   - PASS: task_id mismatch quarantine
   - PASS: from/sender_id mismatch quarantine
2. `npm run poc:cli:check`
   - Codex: OK
   - Claude: `ETIMEDOUT`（isolated/host どちらも再現）
3. `npm run poc:runtime:cli -- --task-id task-cli-model-switch-20260212 --instruction "normal review" --codex-model gpt-5.3-codex --claude-model claude-sonnet-4-5-20250929 --cli-home-mode host`
   - 実行完走
   - `reviewer_failure_counts.network_error=1`
   - `operational_gate=manual_review_network_retry`

---

## 4. 既知課題（未解決）

1. Claude CLIが `spawnSync claude ETIMEDOUT` で不安定。
2. そのため `manual_review_required` 側に倒れるケースが残る。
3. 現状は「失敗を分類して運用判断できる」状態までは達成。
4. ただし「claudeを常時安定稼働」は未達。

---

## 5. ディレクトリ整理で実施したこと

1. `.DS_Store` を削除。
2. `.gitignore` に `tmp/`, `.DS_Store`, `**/.DS_Store` を追加。
3. レビュー索引を追加。
   - `reviews/README.ja.md`

---

## 6. 次担当者の着手順（推奨）

1. `plan/mailbox-poc-roadmap-next.ja.md` の Phase 1 を完了させる。
2. Claude timeoutの原因切り分け（CLI/モデル/ネットワーク/セッション）。
3. `TaskDomain` と `ProcessManager` の実体コードを追加し、`runtime.ts` の直書き分岐を段階移管。
4. `tx` / `post_commit` の分離テストを追加。
5. その後に SQLite state store 実装へ進む。

---

## 7. 参照優先ファイル（引き継ぎ先必読）

1. `src/poc/runtime.ts`
2. `src/poc/runtime-main.ts`
3. `src/poc/e2e.ts`
4. `plan/00-module-boundary-and-interface-contract.ja.md`
5. `plan/mailbox-only-poc.ja.md`
6. `plan/mailbox-poc-runtime.example.yaml`
7. `plan/mailbox-poc-runbook.ja.md`
8. `plan/mailbox-poc-roadmap-next.ja.md`
9. `reviews/poc-self-test-external-review-summary.ja.md`

---

## 8. 引き継ぎ先向けメモ（そのまま渡せる短文）

PoCは mailbox-first で継続。Critical系は `from/sender_id` 検証、運用ゲート出力、契約矛盾解消まで反映済み。`npm run poc:e2e` は3ケースPASS。現時点の主課題は Claude CLI timeout（`ETIMEDOUT`）で、runtimeは `reviewer_failure_counts` と `operational_gate` を返せるため運用判断は可能。次は `TaskDomain/ProcessManager` の実体化（Phase 2）に進めてください。
