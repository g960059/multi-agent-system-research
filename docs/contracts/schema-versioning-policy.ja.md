# Schema Versioning Policy（Mailbox PoC）

最終更新: 2026-02-12  
対象: `schemas/poc/*.schema.json`, mailbox envelope/review/aggregation 契約

## 1. 目的

契約変更を fail-close で管理し、互換性破壊を意図せず本線投入しないための運用ルールを定義する。

## 2. バージョン規約

1. `schema_version=1` は現行安定版とする。
2. 互換性を壊さない変更は `v1` 内で許容する。
3. 互換性を壊す変更は `v2` として新規定義する。

## 3. `v1` で許容する変更

1. 任意フィールドの追加（既存必須フィールドを変更しない）。
2. enum の後方互換追加（既存値は維持）。
3. 説明文、タイトル、メタ情報の更新。

## 4. `v2` が必要な変更

1. 必須フィールドの追加・削除。
2. フィールド名変更、型変更、意味変更。
3. enum 既存値の削除・意味変更。
4. validation を強化し、既存有効データが無効になる変更。

## 5. 互換期間

1. `v2` 導入時は `v1` と `v2` を同時受理する互換期間を設ける。
2. 互換期間の既定は「30日または2リリース」の長い方とする。
3. 互換期間終了日は runbook と release note に明記する。

## 6. In-Flight Task の取り扱い

1. メッセージは `schema_version` を必須とし、未指定は拒否する。
2. consumer は `current` と `previous`（例: `v2` と `v1`）のみ受理する。
3. 未知バージョンは `quarantine` へ隔離し、手動判断に回す。
4. task 実行中にバージョン切替が発生した場合、開始時バージョンで完走させる。
5. 途中切替が必要な場合は replay 手順を用い、同一 task の混在処理を禁止する。

## 7. 移行手順（`v1` -> `v2`）

1. 変更提案: 破壊変更理由、移行影響、rollback 条件をPRに記載。
2. スキーマ追加: `v2` schema を追加し、`v1` を即削除しない。
3. producer 切替: `v2` 出力を段階導入し、必要時は dual-publish を行う。
4. consumer 切替: `v1/v2` 両受理を確認後、`v2` を既定へ変更する。
5. 互換期間終了: `v1` 利用がゼロである証跡確認後に廃止する。

## 8. CI / テスト要件

1. 互換性破壊が疑われる変更は snapshot 差分で検知する。
2. `poc:e2e` で `current/previous` の受理と未知バージョン拒否を検証する。
3. schema ファイル変更時はこの文書へのリンクと影響区分をPRに記載する。

## 9. 例外運用

1. 緊急対応で規約外変更が必要な場合、期限付き例外Issueを起票する。
2. 例外は 1 リリース以内に解消し、通常規約へ戻す。

